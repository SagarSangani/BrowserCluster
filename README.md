# Browser Cluster

**Browser Cluster** æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½ã€åˆ†å¸ƒå¼çš„æµè§ˆå™¨è‡ªåŠ¨åŒ–é›†ç¾¤ç³»ç»Ÿï¼ŒåŸºäº Playwright å’Œ FastAPI æ„å»ºã€‚å®ƒæ”¯æŒå¤§è§„æ¨¡å¹¶å‘ç½‘é¡µæŠ“å–ã€æˆªå›¾ã€PDF ç”ŸæˆåŠè‡ªåŠ¨åŒ–æ“ä½œï¼Œå…·å¤‡å®Œå–„çš„ä»»åŠ¡è°ƒåº¦ã€ç»“æœç¼“å­˜å’ŒèŠ‚ç‚¹ç®¡ç†åŠŸèƒ½ã€‚

![UI Preview](admin/public/image.png)

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

- **åˆ†å¸ƒå¼æ¶æ„**ï¼šæ”¯æŒå¤š Worker èŠ‚ç‚¹æ°´å¹³æ‰©å±•ï¼Œè½»æ¾åº”å¯¹é«˜å¹¶å‘åœºæ™¯ã€‚
- **éšèº«æ¨¡å¼**ï¼šå†…ç½® Stealth æ’ä»¶ï¼Œæœ‰æ•ˆç»•è¿‡åçˆ¬è™«æ£€æµ‹ã€‚
- **é«˜æ•ˆç¼“å­˜**ï¼šåŸºäº Redis çš„ç»“æœç¼“å­˜æœºåˆ¶ï¼Œæ”¯æŒè‡ªå®šä¹‰ TTLã€‚
- **èµ„æºä¼˜åŒ–**ï¼šæ™ºèƒ½æ‹¦æˆªå›¾ç‰‡ã€åª’ä½“èµ„æºï¼Œæ˜¾è‘—æå‡æ¸²æŸ“é€Ÿåº¦ã€‚
- **API æ‹¦æˆª**ï¼šæ”¯æŒåœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­æå–ç‰¹å®š XHR/Fetch æ¥å£æ•°æ®ã€‚
- **å¯è§†åŒ–ç®¡ç†**ï¼šæä¾›åŸºäº Vue 3 + Element Plus çš„ç°ä»£åŒ–ç®¡ç†åå°ã€‚

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **åç«¯**ï¼šPython 3.10, FastAPI, Playwright, RabbitMQ, MongoDB, Redis
- **å‰ç«¯**ï¼šVue 3, Element Plus, Pinia, Vite
- **éƒ¨ç½²**ï¼šDocker (Multi-stage build)

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

![Architecture](admin/public/architecture.png)

### ğŸ”„ ä»»åŠ¡å¤„ç†æµç¨‹

1. **æäº¤ä»»åŠ¡**
   - å®¢æˆ·ç«¯å‘ `API Gateway` å‘é€æŠ“å–è¯·æ±‚ã€‚
   - API é¦–å…ˆæ£€æŸ¥ `Redis` ç¼“å­˜ï¼Œè‹¥å‘½ä¸­åˆ™ç›´æ¥è¿”å›ç»“æœã€‚

2. **ä»»åŠ¡è°ƒåº¦**
   - è‹¥æœªå‘½ä¸­ç¼“å­˜ï¼ŒAPI åœ¨ `MongoDB` åˆ›å»ºä»»åŠ¡è®°å½•ï¼ˆçŠ¶æ€ä¸º pendingï¼‰ã€‚
   - åŒæ—¶å°†ä»»åŠ¡æ¶ˆæ¯å‘å¸ƒåˆ° `RabbitMQ` é˜Ÿåˆ—ã€‚
   - API ç«‹å³è¿”å› `task_id` ç»™å®¢æˆ·ç«¯ï¼ˆå¼‚æ­¥æ¨¡å¼ï¼‰ã€‚

3. **ä»»åŠ¡æ‰§è¡Œ**
   - ç©ºé—²çš„ `Worker` èŠ‚ç‚¹ä» RabbitMQ æ¶ˆè´¹ä»»åŠ¡ã€‚
   - Worker å¯åŠ¨æµè§ˆå™¨ä¸Šä¸‹æ–‡ï¼Œæ‰§è¡Œé¡µé¢åŠ è½½ã€äº¤äº’å’Œæ•°æ®æå–ã€‚

4. **ç»“æœå›å†™**
   - **æˆåŠŸ**ï¼šWorker å°†ç»“æœå†™å…¥ `MongoDB`ï¼Œæ›´æ–°ç¼“å­˜åˆ° `Redis`ï¼Œå¹¶æ ‡è®°ä»»åŠ¡ä¸º successã€‚
   - **å¤±è´¥**ï¼šè®°å½•é”™è¯¯ä¿¡æ¯åˆ° `MongoDB`ï¼Œæ ‡è®°ä»»åŠ¡ä¸º failedã€‚

### æ ¸å¿ƒç»„ä»¶

- **ğŸŒ API Gateway (FastAPI)**
  - ç³»ç»Ÿçš„ç»Ÿä¸€å…¥å£ï¼Œè´Ÿè´£æ¥æ”¶ HTTP è¯·æ±‚ã€å‚æ•°æ ¡éªŒå’Œä»»åŠ¡è°ƒåº¦ã€‚
  - é›†æˆ Redis ç¼“å­˜å±‚ï¼Œå¯¹é‡å¤è¯·æ±‚ç›´æ¥è¿”å›ç¼“å­˜ç»“æœï¼Œæ˜¾è‘—é™ä½ç³»ç»Ÿè´Ÿè½½ã€‚
  - æä¾›å®Œæ•´çš„ä»»åŠ¡ç®¡ç†ã€èŠ‚ç‚¹ç›‘æ§å’Œç³»ç»Ÿé…ç½® APIã€‚

- **ğŸ“¨ Message Queue (RabbitMQ)**
  - å¼‚æ­¥ä»»åŠ¡æ€»çº¿ï¼Œå®ç°ç”Ÿäº§è€…ï¼ˆAPIï¼‰ä¸æ¶ˆè´¹è€…ï¼ˆWorkerï¼‰çš„å®Œå…¨è§£è€¦ã€‚
  - æ”¯æŒä»»åŠ¡æŒä¹…åŒ–ã€ä¼˜å…ˆçº§é˜Ÿåˆ—å’Œ ACK ç¡®è®¤æœºåˆ¶ï¼Œç¡®ä¿é«˜å¹¶å‘ä¸‹çš„ä»»åŠ¡å¯é æ€§ã€‚

- **ğŸ¤– Worker Nodes (Playwright)**
  - åˆ†å¸ƒå¼æ‰§è¡Œå•å…ƒï¼Œæ”¯æŒå®¹å™¨åŒ–éƒ¨ç½²å’Œæ°´å¹³æ‰©å±•ã€‚
  - è´Ÿè´£å¯åŠ¨æµè§ˆå™¨ä¸Šä¸‹æ–‡ï¼Œæ‰§è¡Œé¡µé¢æ¸²æŸ“ã€äº¤äº’ã€æˆªå›¾å’Œæ•°æ®æå–ã€‚
  - å†…ç½® **Stealth Mode** å’Œèµ„æºæ‹¦æˆªç­–ç•¥ï¼Œä¼˜åŒ–æŠ“å–æˆåŠŸç‡å’Œé€Ÿåº¦ã€‚

- **ğŸ’¾ Data Storage**
  - **MongoDB**: å­˜å‚¨å…¨é‡ä»»åŠ¡è®°å½•ã€æŠ“å–ç»“æœã€èŠ‚ç‚¹çŠ¶æ€å’Œç³»ç»Ÿé…ç½®ã€‚
  - **Redis**: ç”¨äºçƒ­ç‚¹æ•°æ®ç¼“å­˜å’Œåˆ†å¸ƒå¼é”ï¼Œæå‡ç³»ç»Ÿå“åº”é€Ÿåº¦ã€‚

- **ğŸ–¥ï¸ Admin Dashboard (Vue 3)**
  - **ç»Ÿè®¡ç›‘æ§**ï¼šå®æ—¶å±•ç¤ºä»»åŠ¡æˆåŠŸç‡ã€å¤„ç†æ—¶é•¿åŠé˜Ÿåˆ—å †ç§¯æƒ…å†µã€‚
  - **ä»»åŠ¡ç®¡ç†**ï¼šå…¨é‡ä»»åŠ¡å†å²æº¯æºï¼Œæ”¯æŒç»“æœé¢„è§ˆåŠé”™è¯¯æ—¥å¿—æŸ¥çœ‹ã€‚
  - **èŠ‚ç‚¹ç®¡ç†**ï¼šç›‘æ§é›†ç¾¤ Worker çŠ¶æ€ã€è´Ÿè½½æƒ…å†µåŠèµ„æºå ç”¨ã€‚
  - **é…ç½®ç®¡ç†**ï¼šåŠ¨æ€è°ƒæ•´æµè§ˆå™¨å¹¶å‘æ•°ã€è¶…æ—¶æ—¶é—´åŠå…¨å±€ä»£ç†è®¾ç½®ã€‚
  - **ç”¨æˆ·ç®¡ç†**ï¼šåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ (RBAC)ï¼Œä¿éšœç³»ç»Ÿå®‰å…¨ã€‚

## ğŸ“¦ å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- Python 3.10
- Node.js 22 
- RabbitMQ, MongoDB, Redis

### æœ¬åœ°å¼€å‘

1. **å…‹éš†ä»“åº“**
   ```bash
   git clone https://github.com/934050259/BrowserCluster.git
   cd browser-cluster
   ```

2. **ç¯å¢ƒé…ç½®**
   å¤åˆ¶ç¤ºä¾‹é…ç½®æ–‡ä»¶å¹¶æ ¹æ®å®é™…ç¯å¢ƒä¿®æ”¹ï¼š
   ```bash
   cp .env.example .env
   # Windows (PowerShell)
   # copy .env.example .env
   ```
   
   ä¿®æ”¹ `.env` æ–‡ä»¶ä¸­çš„æ•°æ®åº“å’Œæ¶ˆæ¯é˜Ÿåˆ—è¿æ¥ä¿¡æ¯ï¼š
   ```ini
   MONGO_URI=mongodb://localhost:27017/
   REDIS_URL=redis://localhost:6379/0
   RABBITMQ_URL=amqp://guest:guest@localhost:5672/
   ```

3. **åˆå§‹åŒ–é…ç½®**
   è¿è¡Œåˆå§‹åŒ–è„šæœ¬ï¼Œå°†é»˜è®¤é…ç½®å¯¼å…¥ SQLite æ•°æ®åº“ï¼ˆä¾›ç³»ç»Ÿé…ç½®ç®¡ç†ä½¿ç”¨ï¼‰ï¼š
   ```bash
   python scripts/init_configs_db.py
   ```

4. **åç«¯è®¾ç½®**
   ```bash
   # å®‰è£…ä¾èµ–
   pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
   playwright install chromium

   # å¯åŠ¨ API æœåŠ¡
   uvicorn app.main:app --reload
   ```

5. **å‰ç«¯è®¾ç½®**
   ```bash
   cd admin
   npm install
   npm run build  # æ„å»ºåç”±åç«¯ç»Ÿä¸€æ‰˜ç®¡ï¼Œæˆ–è¿è¡Œ npm run dev è¿›è¡Œå¼€å‘
   ```

6. **è®¿é—®ç³»ç»Ÿ**
   - ç®¡ç†åå°ï¼š`http://localhost:8000` (åç«¯æ‰˜ç®¡) æˆ– `http://localhost:5173` (Vite å¼€å‘æ¨¡å¼)
   - API æ–‡æ¡£ï¼š`http://localhost:8000/docs`

## ğŸ³ Docker éƒ¨ç½²

æœ¬é¡¹ç›®æ”¯æŒå¤šé˜¶æ®µæ„å»ºï¼Œé•œåƒå†…å·²é›†æˆå‰ç«¯é™æ€èµ„æºå’Œåç«¯æœåŠ¡ã€‚

### 1. é…ç½®é•œåƒåŠ é€Ÿ (å¯é€‰)
ä¸ºäº†æå‡å›½å†…æ„å»ºé€Ÿåº¦ï¼Œå»ºè®®é…ç½® Docker é•œåƒåŠ é€Ÿå™¨ã€‚

### 2. æ„å»ºé•œåƒ

```powershell
docker build -t browser-cluster:latest .
```

### 3. è¿è¡Œå®¹å™¨

æ¨èä½¿ç”¨ `--env-file` ä¼ é€’æœ¬åœ°é…ç½®ï¼š

```powershell
docker run -d `
  --name browser-cluster `
  -p 8000:8000 `
  --env-file .env `
  -v ${PWD}/logs:/app/logs `
  browser-cluster:latest
```

> **æ³¨æ„**ï¼š
> 1. è¯·ç¡®ä¿ `.env` ä¸­çš„ `MONGO_URI`ã€`REDIS_URL` ç­‰åœ°å€å¯¹å®¹å™¨å¯è§ï¼ˆå¦‚ä½¿ç”¨å®¿ä¸»æœº IPï¼‰ã€‚
> 2. `${PWD}/logs` ç”¨äºæŒä¹…åŒ–æ—¥å¿—ã€‚

## âš™ï¸ é…ç½®è¯´æ˜

ä¸»è¦é…ç½®é¡¹ï¼ˆå¯é€šè¿‡ `.env` æˆ–ç¯å¢ƒå˜é‡è®¾ç½®ï¼‰ï¼š

| å˜é‡å | é»˜è®¤å€¼ | è¯´æ˜ |
| :--- | :--- | :--- |
| `MONGO_URI` | `mongodb://localhost:27017/` | MongoDB è¿æ¥åœ°å€ |
| `REDIS_URL` | `redis://localhost:6379/0` | Redis é˜Ÿåˆ—/ç¼“å­˜è¿æ¥åœ°å€ |
| `RABBITMQ_URL` | `amqp://guest:guest@localhost:5672/` | RabbitMQ è¿æ¥åœ°å€ |
| `BROWSER_TYPE` | `chromium` | æµè§ˆå™¨ç±»å‹ |
| `HEADLESS` | `true` | æ˜¯å¦å¼€å¯æ— å¤´æ¨¡å¼ |
| `WORKER_CONCURRENCY` | `3` | å•ä¸ª Worker çš„å¹¶å‘çº¿ç¨‹æ•° |
| `NODE_ID` | `node-1` | èŠ‚ç‚¹å”¯ä¸€æ ‡è¯† |

## ğŸ“ ä»»åŠ¡å‚æ•°è¯´æ˜

### 1. æŠ“å–æ¥å£ (POST /api/v1/scrape)

è¿™æ˜¯æœ€æ ¸å¿ƒçš„æ¥å£ï¼Œæ”¯æŒåŒæ­¥æŠ“å–å¹¶è¿”å›æ¸²æŸ“åçš„ç»“æœã€‚

#### **è¯·æ±‚ä½“ (JSON)**

| å‚æ•°å | ç±»å‹ | å¿…é€‰ | é»˜è®¤å€¼ | è¯´æ˜ |
| :--- | :--- | :--- | :--- | :--- |
| `url` | string | æ˜¯ | - | ç›®æ ‡ç½‘é¡µçš„å®Œæ•´ URL åœ°å€ |
| `params` | object | å¦ | `{}` | è¯¦ç»†çš„æŠ“å–é…ç½®å‚æ•°ï¼ˆè§ä¸‹è¡¨ï¼‰ |
| `cache` | object | å¦ | `{"enabled": true, "ttl": 3600}` | ç¼“å­˜é…ç½®ï¼ˆè§ä¸‹è¡¨ï¼‰ |
| `priority` | int | å¦ | `1` | ä»»åŠ¡ä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå¤§è¶Šä¼˜å…ˆå¤„ç† |

#### **cache é…ç½®è¯¦è§£**

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| `enabled` | bool | `true` | æ˜¯å¦å¯ç”¨ç¼“å­˜ |
| `ttl` | int | `3600` | ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 1 å°æ—¶ |

#### **params é…ç½®è¯¦è§£**

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| `wait_for` | string | `networkidle` | ç­‰å¾…ç­–ç•¥ï¼š`networkidle` (ç½‘ç»œç©ºé—²), `load` (åŠ è½½å®Œæˆ), `domcontentloaded` |
| `wait_time` | int | `3000` | é¡µé¢åŠ è½½å®Œæˆåçš„é¢å¤–ç­‰å¾…æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œç”¨äºå¤„ç†å¼‚æ­¥æ¸²æŸ“ |
| `timeout` | int | `30000` | æŠ“å–æ€»è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ |
| `selector` | string | `null` | ç­‰å¾…ç‰¹å®šçš„ CSS é€‰æ‹©å™¨å‡ºç°åå†è¿”å›ç»“æœ |
| `screenshot` | bool | `false` | æ˜¯å¦ç”Ÿæˆé¡µé¢æˆªå›¾ |
| `is_fullscreen` | bool | `false` | æ˜¯å¦æˆªå–å…¨å±ï¼ˆä»…åœ¨ `screenshot` ä¸º true æ—¶ç”Ÿæ•ˆï¼‰ |
| `block_images` | bool | `false` | æ˜¯å¦æ‹¦æˆªå›¾ç‰‡èµ„æºåŠ è½½ï¼Œå¯æ˜¾è‘—æå‡é€Ÿåº¦ |
| `block_media` | bool | `false` | æ˜¯å¦æ‹¦æˆªè§†é¢‘ã€éŸ³é¢‘ã€å­—ä½“ã€CSS ç­‰åª’ä½“å’Œèµ„æº |
| `user_agent` | string | `null` | è‡ªå®šä¹‰æµè§ˆå™¨ User-Agent |
| `stealth` | bool | `true` | æ˜¯å¦å¯ç”¨åæ£€æµ‹æ’ä»¶ï¼Œæ¨¡æ‹ŸçœŸå®äººç±»è¡Œä¸º |
| `intercept_apis` | list | `[]` | è¦æ‹¦æˆªå¹¶æå–æ•°æ®çš„æ¥å£ URL æ¨¡å¼åˆ—è¡¨ï¼ˆæ”¯æŒæ­£åˆ™ï¼‰ |
| `intercept_continue` | bool | `false` | æ‹¦æˆªæ¥å£åæ˜¯å¦ç»§ç»­è¯·æ±‚ï¼ˆé»˜è®¤ False ä¸ºä¸­æ­¢è¯·æ±‚ï¼‰ |
| `viewport` | object | `{"width": 1920, "height": 1080}` | æ¨¡æ‹Ÿçš„æµè§ˆå™¨è§†å£å¤§å° |
| `proxy` | object | `null` | ä»£ç†æœåŠ¡å™¨é…ç½®ï¼Œæ ¼å¼ï¼š`{"server": "...", "username": "...", "password": "..."}` |

#### **è¯·æ±‚ç¤ºä¾‹**

```json
{
  "url": "https://example.com",
  "params": {
    "wait_for": "networkidle",
    "screenshot": true,
    "block_images": true,
    "stealth": true,
    "intercept_apis": ["/api/v1/data/.*"],
    "proxy": {
      "server": "http://proxy.example.com:8080"
    }
  },
  "cache": {
    "enabled": true,
    "ttl": 3600
  }
}
```

### 2. å¼‚æ­¥æŠ“å– (POST /api/v1/scrape/async)

å¼‚æ­¥æäº¤æŠ“å–ä»»åŠ¡ï¼Œä¸ç­‰å¾…æ‰§è¡Œç»“æœï¼Œç«‹å³è¿”å›ä»»åŠ¡ IDã€‚é€‚ç”¨äºè€—æ—¶è¾ƒé•¿çš„ä»»åŠ¡æˆ–ä¸éœ€è¦å³æ—¶å“åº”çš„åœºæ™¯ã€‚

#### **è¯·æ±‚ä½“**
ä¸åŒæ­¥æŠ“å–æ¥å£ (`/api/v1/scrape`) å®Œå…¨ä¸€è‡´ã€‚

#### **å“åº”ç¤ºä¾‹**
```json
{
  "task_id": "65b2...",
  "url": "https://example.com",
  "status": "pending",
  "created_at": "2024-01-25T10:00:00"
}
```

### 3. æ‰¹é‡æŠ“å– (POST /api/v1/scrape/batch)

æ”¯æŒä¸€æ¬¡æ€§æäº¤å¤šä¸ªæŠ“å–ä»»åŠ¡ã€‚æ‰¹é‡æ¥å£ç›®å‰ä»…æ”¯æŒå¼‚æ­¥æ¨¡å¼ï¼Œä¸ç›´æ¥è¿”å›æŠ“å–ç»“æœã€‚

#### **è¯·æ±‚ä½“**
```json
{
  "tasks": [
    {
      "url": "https://example.com/1",
      "params": { ... }
    },
    {
      "url": "https://example.com/2",
      "priority": 2
    }
  ]
}
```

### 4. ä»»åŠ¡ç®¡ç†æ¥å£

ç”¨äºæŸ¥è¯¢å¼‚æ­¥/æ‰¹é‡ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€å’Œç»“æœã€‚

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
| :--- | :--- | :--- |
| `/api/v1/tasks/{task_id}` | GET | è·å–å•ä¸ªä»»åŠ¡è¯¦æƒ…ï¼ˆåŒ…å«æŠ“å–ç»“æœï¼‰ |
| `/api/v1/tasks` | GET | åˆ†é¡µè·å–ä»»åŠ¡åˆ—è¡¨ï¼Œæ”¯æŒçŠ¶æ€/URLæœç´¢ |
| `/api/v1/tasks/{task_id}/retry` | POST | é‡è¯•å¤±è´¥çš„ä»»åŠ¡ |
| `/api/v1/tasks/{task_id}` | DELETE | åˆ é™¤æŒ‡å®šä»»åŠ¡ |
| `/api/v1/tasks/batch` | DELETE | æ‰¹é‡åˆ é™¤ä»»åŠ¡ |

## ğŸ“„ License

MIT
